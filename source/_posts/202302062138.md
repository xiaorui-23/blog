---
title: Vue 2 ä¸­å®ç° CustomRef æ–¹å¼é˜²æŠ–/èŠ‚æµ
cover: https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d204f96489e34320b00672d342463ced~tplv-k3u1fbpfcp-no-mark:480:480:0:0.awebp?
tags: 
  - å‰ç«¯
  - Vue
  - JavaScript
categories: 
  - å‰ç«¯
  - Vue
date: 2023-02-06
description: ä»Šå¤©ç»™å¤§å®¶å¸¦æ¥çš„æ˜¯Vue 2 ä¸­çš„å®ç° CustomRef æ–¹å¼é˜²æŠ–/èŠ‚æµè¿™ç¯‡æ–‡ç« ï¼Œå‰å‡ å¤©åˆ©ç”¨ customRef å®ç°äº†åœ¨ vue 3 ä¸­çš„æè‡´é˜²æŠ–/èŠ‚æµçš„æ–°æ–¹å¼ã€‚æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç‚¹å‡» ğŸ‘‰ Vue
---



ä»Šå¤©ç»™å¤§å®¶å¸¦æ¥çš„æ˜¯`Vue 2 ä¸­çš„å®ç° CustomRef æ–¹å¼é˜²æŠ–/èŠ‚æµ`è¿™ç¯‡æ–‡ç« ï¼Œå‰å‡ å¤©åˆ©ç”¨ `customRef` å®ç°äº†åœ¨ vue 3 ä¸­çš„æè‡´é˜²æŠ–/èŠ‚æµçš„æ–°æ–¹å¼ã€‚æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç‚¹å‡» ğŸ‘‰ [Vue 3 ä¸­çš„æè‡´é˜²æŠ–/èŠ‚æµï¼ˆå«å¸¸è§æ–¹å¼é˜²æŠ–/èŠ‚æµï¼‰](https://juejin.cn/post/7196150790368215077) è¿›è¡ŒæŸ¥çœ‹ã€‚

# å‰è¨€

åœ¨å‰ç«¯çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåœ¨æ¶‰åŠåˆ°ä¸ç”¨æˆ·äº¤äº’çš„è¿‡ç¨‹ä¸­æ˜¯åŸºæœ¬ä¸Šéƒ½æ˜¯éœ€è¦å¤„ç†çš„ï¼Œå¸¸è§„æ“ä½œå°±æ˜¯åœ¨å¯¹åº”ä½ç½®åŠ ä¸Šé˜²æŠ–æˆ–è€…èŠ‚æµã€‚

åŠ ä¸Šé˜²æŠ–æˆ–è€…èŠ‚æµçš„ä½œç”¨ï¼šä¸€æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·é¢‘ç¹æ“ä½œï¼›äºŒæ˜¯ä¸ºäº†èŠ‚çº¦ä¸€å®šçš„æœåŠ¡å™¨èµ„æºï¼Œå‡å°‘èµ„æºæµªè´¹çš„æƒ…å†µã€‚

# èƒŒæ™¯

ä¹‹æ‰€ä»¥å†™è¿™ç¯‡æ–‡ç« æ˜¯å› ä¸ºå•¥å‘¢ï¼Ÿæˆ‘å†™å®Œ[Vue 3 ä¸­çš„æè‡´é˜²æŠ–/èŠ‚æµï¼ˆå«å¸¸è§æ–¹å¼é˜²æŠ–/èŠ‚æµï¼‰](https://juejin.cn/post/7196150790368215077) è¿™ç¯‡æ–‡ç« åï¼Œçªç„¶èŒå‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¿ƒæƒ³æ—¢ç„¶ `vue 3` å¯ä»¥é€šè¿‡ `customRef` å®ç°ï¼Œé‚£ `vue 2` æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¿™æ ·è¿›è¡Œç…§è‘«èŠ¦ç”»ç“¢å‘¢ï¼Ÿç„¶åæˆ‘å°±æƒ³äº†ä¸€ä¸‹ï¼Œæ˜¯å¯ä»¥çš„ï¼Œç„¶ååŠ ä¸Šä»Šæ™šä¸Šæœ‰ç©ºï¼Œæˆ‘å°±å†™äº†ä¸€ä¸‹ï¼Œè™½ç„¶æ²¡ `vue 3` è‡ªå¸¦çš„é‚£ä¹ˆå¥½ï¼Œä½†è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ã€‚æ‰€ä»¥ç‰¹æ­¤æ¥åˆ†äº«ä¸€ä¸‹ã€‚

æœ‰äººè¯´ `vue 2` æ²¡ `ref` å’Œ `customRef` å•Šï¼Ÿ

è¯¶ï¼Œåˆ«å¿˜äº†æœ‰ `proxy` å’Œ `Object.defineProperty` å‘€ã€‚

æˆ‘è¿™é‡Œå®ç°çš„æ–¹å¼å°±é‡‡ç”¨çš„æ˜¯ `proxy`, ç„¶åå®ç°åçš„æ•ˆæœå’Œ `customRef` å·®ä¸å¤šï¼Œåªæ˜¯åœ¨ `template` æ¨¡æ¿ä¸­ä¼šå¸¦ä¸ª `value` ä¸èƒ½å»æ‰ã€‚

å¼€å§‹å§ï¼

# æ’¸ä»£ç 

æˆ‘è¿™é‡Œç›´æ¥æ”¾ä»£ç ï¼Œæ¯è¡Œä»£ç æˆ‘éƒ½åŠ äº†æ³¨é‡Šçš„ï¼Œæ–¹ä¾¿é˜…è¯»ï¼Œå½“ç„¶æœ‹å‹ä½ æœ‰ç–‘é—®æˆ–è€…è¯´æ²¡çœ‹æ‡‚çš„åœ°æ–¹å¯ä»¥è¯„è®º + ç§ä¿¡ã€‚

## é˜²æŠ–ï¼ˆdebounceï¼‰

### ä»£ç 

```javascript
// å£°æ˜
// data ä¸ºæ•°æ®
// delay ä¸ºæ—¶é—´ã€‚delay = null åˆ™ç›´æ¥ä¸ä½¿ç”¨ é˜²æŠ– æ–¹æ¡ˆ
function debounceRef (data, delay = 300) {
    // å®šæ—¶å™¨
    let timer = null
    // æ•°æ®
    const value = {value: data}
    // åˆ›å»º proxy å®ä¾‹
    const proxy = new Proxy(value, {
        get(target, property) {
            // è¿”å›å½“å‰å€¼
            return target[property]
        },
        // set å‚æ•°è¯´æ˜
        // targetï¼šç›®æ ‡, propertyï¼šå±æ€§, newValue å€¼, receiverï¼šæ¥æ”¶è€…
        set(target, property, newValue, receiver) {
            // å®šæ—¶å™¨åˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨åˆ™æ¸…é™¤å½“å‰å®šæ—¶å™¨
            if(timer != null){
                // æ¸…é™¤å®šæ—¶å™¨
                clearTimeout(timer)
                // å°† timer æ¢å¤é»˜è®¤å€¼
                timer = null
            }
            // èµ‹å€¼å¹¶åˆ›å»ºå®šæ—¶å™¨
            timer = setTimeout(() => {
                // ä¿®æ”¹å€¼
                target[property] = newValue
            }, delay)
            // è®© set ä¸€ç›´è¿”å› true
            // ä¸è¿”å› trueï¼Œåˆ™ä¼šæŠ¥ä¸‹åˆ—é”™è¯¯ï¼š 'set' on proxy: trap returned falsish for property 'value'
            return true;
        }
    })
    // åˆ¤æ–­ delay === nullï¼Œç­‰äºåˆ™è¿”å›æœªä»£ç†çš„å¯¹è±¡ï¼Œåä¹‹
    return delay === null ?value : proxy
}
```

### ä½¿ç”¨

```javascript
// å¼•å…¥
import debounceRef from "./utils/debounceRef.js"

// åˆ›å»º
data () {
  return {
      count: debounceRef(0, 300)
  }
}
```

**åœ¨é¡µé¢ä¸­ä½¿ç”¨ï¼š**

```html
// span
<span>{{ count.value }}</span>

// v-model
<input type="text" v-model="count.value">
```

**åœ¨å‡½æ•°ä¸­ä½¿ç”¨ï¼š**
```javascript
// å‡½æ•°
addCount () {
    this.count.value += 1            
}
```

## èŠ‚æµï¼ˆthrottleï¼‰

### ä»£ç 

```javascript
// å£°æ˜
// data ä¸ºæ•°æ®
// delay ä¸ºæ—¶é—´ã€‚delay = null åˆ™ç›´æ¥ä¸ä½¿ç”¨ èŠ‚æµ æ–¹æ¡ˆ
function throttleRef (data, delay = 300) {
    // å®šæ—¶å™¨
    let timer = null
    // æ•°æ®
    const value = {value: data}
    // åˆ›å»º proxy å®ä¾‹
    const proxy = new Proxy(value, {
        get(target, property) {
            // è¿”å›å½“å‰å€¼
            return target[property]
        },
        // set å‚æ•°è¯´æ˜
        // targetï¼šç›®æ ‡, propertyï¼šå±æ€§, newValue å€¼, receiverï¼šæ¥æ”¶è€…
        set(target, property, newValue, receiver) {
             // å®šæ—¶å™¨åˆ¤æ–­
            if(timer === null){
                // èµ‹å€¼å¹¶åˆ›å»ºå®šæ—¶å™¨
                timer = setTimeout(() => {
                    // ä¿®æ”¹å€¼
                    target[property] = newValue
                    // æ¸…é™¤å®šæ—¶å™¨
                    clearTimeout(timer)
                    // å°† timer æ¢å¤é»˜è®¤å€¼
                    timer = null
                }, delay)
            }
            // è®© set ä¸€ç›´è¿”å› true
            // ä¸è¿”å› trueï¼Œåˆ™ä¼šæŠ¥ä¸‹åˆ—é”™è¯¯ï¼š 'set' on proxy: trap returned falsish for property 'value'
            return true;
        }
    })
    // åˆ¤æ–­ delay === nullï¼Œç­‰äºåˆ™è¿”å›æœªä»£ç†çš„å¯¹è±¡ï¼Œåä¹‹
    return delay === null ?value : proxy
}
```

### ä½¿ç”¨

```javascript
// å¼•å…¥
import throttleRef from "./utils/throttleRef.js"

// åˆ›å»º
data () {
  return {
      count: throttleRef(0, 300)
  }
}
```

**åœ¨é¡µé¢ä¸­ä½¿ç”¨ï¼š**

```html
// span
<span>{{ count.value }}</span>

// v-model
<input type="text" v-model="count.value">
```

**åœ¨å‡½æ•°ä¸­ä½¿ç”¨ï¼š**
```javascript
// å‡½æ•°
addCount () {
    this.count.value += 1            
}
```

# æ€»ç»“

ä»¥ä¸Šå°±æ˜¯`Vue 2 ä¸­çš„å®ç° CustomRef æ–¹å¼é˜²æŠ–/èŠ‚æµ`è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹ã€‚å—[Vue 3 ä¸­çš„æè‡´é˜²æŠ–/èŠ‚æµï¼ˆå«å¸¸è§æ–¹å¼é˜²æŠ–/èŠ‚æµï¼‰](https://juejin.cn/post/7196150790368215077)ä¸­åˆ©ç”¨ `customRef`çš„å¯å‘ã€‚

å¸Œæœ›æœ¬ç¯‡æ–‡ç« å¯¹æœ‹å‹ä½ åœ¨ä½¿ç”¨ `vue 2`çš„è¿‡ç¨‹ä¸­æœ‰æ‰€å¸®åŠ©ã€‚è‹¥ç¯‡ä¸­æœ‰ä¸è¶³ä¹‹å¤„æˆ–ä½ æœ‰ä¸ä¸€æ ·çš„æƒ³æ³•æˆ–è§è§£ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€ + å…³æ³¨ã€‚

æˆ‘æ˜¯[æ¡ƒå°ç‘](https://juejin.cn/user/1196739061361437)ï¼Œå…¬ä¼—å· @ æ¡ƒå°ç‘ã€‚

